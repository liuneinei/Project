<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
    <link rel="icon" sizes="any" mask href="images/favicon.ico" />
    <title>即时聊天 - Chat</title>
    <link rel="stylesheet" type="text/css" href="css/socket.css?v1.3">
    <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.js"></script>
    <script src="http://m.dumanyi.com/Content/js/vue.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .messages .nicknames .checkhui {
            background: #ccc;
        }

        .messages .nicknames .check {
            background: #ff0000;
        }
    </style>
</head>
<body>
    <h1>Scoket.IO Chat Demo</h1>
    <div class="wrap chatroom">
        <div class="messages">
            <div class="nicknames kefu-users">
                <span>客服在线：</span>
                <!--<b>小明</b>
                <b>小黄</b>-->
            </div>
            <div class="nicknames kefu-rooms">
                <span>Room：</span>
                <!--<b>小明</b>
                <b>小黄</b>-->
            </div>
            <div class="lines">
                <!--<p><b>小明:</b>我好像长高了!</p>
                <p><b>小黄:</b>我英语变好了!</p>
                <p><b>我:</b>我变态了!</p>-->
            </div>
        </div>
        <form class="send-message">
            <span class="to">发送给<b>所有人</b></span>
            <input class="nick message" type="text" placeholder="在这里输入消息发送" />
            <button>发送</button>
        </form>
    </div>
    <script type="text/javascript">
        $(function () {
            var kefu_user_cookieid = $.cookie('kefu_user_cookieid') || '';
            if (kefu_user_cookieid == '') {
                window.location = '/login.html';
            }

            var $lines = $('.lines'),
				$nickname = $('.nickname'),
				$messages = $('.messages'),
				$message = $('.message'),
				$sendMessage = $('.send-message'),
				toUser = null;
            var $id = '';

            var socket = io.connect('http://wxnnn.wang:8087');

            /*
			*	初始化
			*/
            socket.on('init:push', function (push) {
                // 客服登录验证
                socket.emit('kefu_user_login:verification', push.socketid, kefu_user_cookieid, function (resver) {
                    console.log(resver);
                    if (!resver.result) {
                        alert('登录失效');
                        window.location = '/login.html';
                        return;
                    }
                });
            });

            /*
			*	客服在线信息
			*/
            socket.on('kefu_user:onlines', function (res) {
                $('.kefu-users').empty().append($('<span>当前在线：</span>'));
                $.each(res, function (key, val) {
                    $('.kefu-users').append($('<b>').text(val.name));
                });
            });

            /*
			*	对应的用户信息
			*/
            socket.on('members:' + kefu_user_cookieid, function (res) {
                if (res.type == 'list') { // 集合
                    $('.kefu-rooms').empty().append($('<span>Room：</span>'));
                    $.each(res.rooms, function (key, val) {
                        if (val.id == $id) {
                            $('.kefu-rooms').append($('<b style="background: #ff0000;" id="' + val.id + '">').text(val.name).data('id', val.id).append($('<span>').html(val.messagenum)));
                        } else {
                            $('.kefu-rooms').append($('<b id="' + val.id + '">').text(val.name).data('id', val.id).append($('<span>').html(val.messagenum)));
                        }

                        // 未在线
                        if (val.status == 0) {
                            $('.kefu-rooms').find('b#' + val.id).addClass('checkhui');
                        }
                    });
                } else if (res.type == 'new' || res.type == 'dis') { // 新用户 // 转移
                    $('.kefu-rooms').append($('<b style="background: #ff0000;" id="' + res.rooms.id + '">').text(res.rooms.name).data('id', res.rooms.id).append($('<span>').html('0')));
                } else if (res.type == 'on') { // 用户上线
                    var eleid= $('[id=' + res.rooms.id + ']');
                    eleid.removeClass('checkhui');
                } else if (res.type == 'off') { // 用户下线
                    var eleid = $('[id=' + res.rooms.id + ']');
                    eleid.removeClass('check');
                    if (!eleid.hasClass('checkhui')) {
                        eleid.addClass('checkhui');
                    }
                }
            });

            // 呼叫客服加入房间
            socket.on('room:join:' + kefu_user_cookieid, function (res) {
                socket.emit('online:join', res.membersocketid, function () { });
            });

            // 连接提示操作
            socket.on('announcement', function (msg) {
                $lines.append($('<p>').append($('<em>').text(msg)));
                $lines.scrollTop(100000000);
            });

            function message(from, msg, opt_to) {
                var label;
                var times = new Date();
                var hours = times.getHours();
                hours = hours < 10 ? '0' + hours : hours;
                var minutes = times.getMinutes();
                minutes = minutes < 10 ? '0' + minutes : minutes;

                if (opt_to) {
                    label = $('<b>').html('[' + hours + ":" + minutes + ']' + from + '对' + opt_to + '说:');
                } else {
                    label = $('<b>').html('[' + hours + ":" + minutes + ']' + from + ':');
                }
                $lines.append($('<p>').append(label, msg));
                $lines.scrollTop(100000000);
            }

            socket.on('user:pub', function (backobj) {
                if (backobj.id == $id) {
                    message(backobj.name, backobj.message);
                } else if (backobj.id != $id) {
                    var $roomtext = $('[id="' + backobj.id + '"] span');
                    $roomtext.html(parseInt($roomtext.html()) + 1);
                }
            });

            socket.on('user:private', message);
            socket.on('reconnect', function () {
                //$lines.remove();
                message('<i>系统消息</i>', '重连了');
            });
            socket.on('reconnecting', function () {
                message('<i>系统消息</i>', '尝试重连中');
            });
            socket.on('error', function (e) {
                message('<i>系统消息</i>', e ? e : '未知错误');
            });
            socket.on('connect_failed', function (e) {
                console.log('连接失败');
            });
            socket.on('disconnect', function (e) {
                $messages.hide();
                $sendMessage.hide();
                $nickname.show();
            });

            function clear() {
                $message.val('').focus();
            }

            $sendMessage.submit(function () {
                message('我', $message.val());
                socket.emit('user:pub', $message.val(), $id);
                clear();
                $lines.scrollTop(100000000);
                return false;
            });

            $('.kefu-rooms').on('click', 'b', function (e) {
                $lines.empty();
                var $bitem = $(e.target);
                $bitem.siblings('b').removeClass('check');
                $id = $bitem.data('id');
                if (($id || 0) > 0) {
                    $bitem.addClass('check');
                    $bitem.find('span').html('0');
                    // 呼叫Room的消息
                    socket.emit('kefu_user_message:to_roomid', $id, messagetoroomidBackFun);
                    // 呼叫Room的消息 回调
                    function messagetoroomidBackFun(resmessage) {
                        if (!resmessage.result) return;

                        var $messagerows = resmessage.rows;
                        if ($messagerows.length > 0) {
                            [].forEach.call($messagerows, function (item, index) {
                                //console.log(item.name);
                                message(item.name, item.content);
                            });
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>